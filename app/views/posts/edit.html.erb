<h1>編輯文章</h1>
<%= form_with model: @post, local: true do |f| %>
  <div class="form-group">
    <%= f.label :title, "標題" %>
    <%= f.text_field :title, class: "form-control" %>
  </div>
  <div class="form-group">
    <%= f.label :content, "內容" %>
    <%= f.rich_text_area :content, class: "form-control" %>
  </div>
  <%= f.submit "更新", class: "btn btn-primary" %>
<% end %>
<%= link_to "回到列表", posts_path, class: "btn btn-secondary" %>

<button type="button" id="open-preview" class="btn btn-secondary" style="margin-top:12px;">預覽</button>

<div id="preview-modal" class="modal" aria-hidden="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1000; align-items:center; justify-content:center;">
  <div class="modal-dialog" style="background:#fff; max-width:800px; width:90%; border-radius:8px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.2);">
    <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #eee;">
      <h3 class="modal-title" style="margin:0;">文章預覽</h3>
      <button type="button" id="close-preview" aria-label="關閉" style="background:none; border:none; font-size:20px; cursor:pointer;">×</button>
    </div>
    <div class="modal-body" style="padding:16px;">
      <h2 class="preview-title" style="margin-top:0;"></h2>
      <div class="preview-content"></div>
    </div>
    <div class="modal-footer" style="padding:12px 16px; border-top:1px solid #eee; text-align:right;">
      <button type="button" id="close-preview-2" class="btn btn-secondary">關閉</button>
    </div>
  </div>
</div>

<%= javascript_tag nonce: true do %>
  document.addEventListener("DOMContentLoaded", function() {
    const form = document.querySelector("form");
    if (!form) return;
    const titleInput = form.querySelector('input[name="post[title]"]');
    const contentInput = form.querySelector('input[name="post[content]"]');
    const modal = document.getElementById('preview-modal');
    const openBtn = document.getElementById('open-preview');
    const closeBtn = document.getElementById('close-preview');
    const closeBtn2 = document.getElementById('close-preview-2');
    const dialog = modal.querySelector('.modal-dialog');
    const previewTitle = modal.querySelector('.preview-title');
    const previewContent = modal.querySelector('.preview-content');

    function openModal() {
      if (previewTitle && titleInput) previewTitle.textContent = titleInput.value || "";
      if (previewContent && contentInput) previewContent.innerHTML = contentInput.value || "";
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');
    }
    function closeModal() {
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
    }

    if (openBtn) openBtn.addEventListener('click', openModal);
    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (closeBtn2) closeBtn2.addEventListener('click', closeModal);
    modal.addEventListener('click', function(e) {
      if (!dialog.contains(e.target)) closeModal();
    });
  });
<% end %>